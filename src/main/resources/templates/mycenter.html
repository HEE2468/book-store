<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>个人中心</title>
    <link href="css/mycenter/style.css" type="text/css" rel="stylesheet"/>
    <link href="layui/css/layui.css" type="text/css" rel="stylesheet"/>
    <script src="layui/layui.js" type="text/javascript"></script>
    <script src="plugins/jquery/dist/jquery.min.js"></script>
</head>
<body>

<div class="my_center">
    <!-- header -->
    <div class="site-header">
        <div class="site-logo">
            <img class="header-logo" src="images/logo.png">
        </div>
        <div class="header-nav">
            <ul class="nav-list">
                <li class="li-item-center">
                    <a class="item-center" href="">个人中心</a>
                </li>
                <li class="li-item-logout">
                    <a class="item-logout" onclick="logout()">退出</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- 个人信息 -->
    <div class="site-out-box">
        <div class="site-in-box">
            <div class="base-infos">
                <h1 class="base-infos-text">基本信息</h1>
                <div class="base-infos-list">
                    <form class="layui-form" action="">
                        <div class="layui-upload message-photo">
                            <div class="layui-upload-list">
                                <img class="layui-upload-img" style="width: 100px;height: 100px" :src="info.userPhoto==null?'images/mycenter/u173.svg':info.userPhoto" id="demo1">
                                <p id="demoText"></p>
                                <button type="button" class="layui-btn photo-btn" id="test1">上传图片</button>
                            </div>
                        </div>
                        <div class="layui-form-item message-box">
                            <label class="layui-form-label"><span style="color: #F04844"> *&nbsp </span>用户名</label>
                            <div class="layui-input-block">
                                <input type="text" v-model="info.userName" lay-verify="title" autocomplete="off" placeholder="" class="layui-input message-use">
                            </div>
                        </div>
                        <div class="layui-form-item message-box">
                            <label class="layui-form-label"><span style="color: #F04844"> *&nbsp </span>性别</label>
                            <div class="layui-input-block">
                                <input type="text" v-model="info.sex==0?'女':'男'" lay-verify="title" autocomplete="off" placeholder="" class="layui-input message-use">
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="base-infos-password">
                <h1 class="infos-password-text">密码管理</h1>
                <div class="infos-password-list">
                    <form class="layui-form" action="">
                        <div class="layui-form-item message-box">
                            <label class="layui-form-label"><span style="color: #F04844"> *&nbsp </span>原密码</label>
                            <div class="layui-input-block">
                                <input type="text" v-model="oldPassword" @input="changeOldPassword()" lay-verify="title" autocomplete="off" placeholder="" class="layui-input message-use">
                            </div>
                            <span style="color: red;margin-left: 110px;">{{oldPasswordTip}}</span>
                        </div>
                        <div class="layui-form-item message-box">
                            <label class="layui-form-label"><span style="color: #F04844"> *&nbsp </span>新密码</label>
                            <div class="layui-input-block">
                                <input type="text" v-model="newPassword" @input="changeNewPassword()" lay-verify="title" autocomplete="off" placeholder="" class="layui-input message-use">
                            </div>
                            <span style="color: red;margin-left: 110px;">{{newPasswordTip}}</span>
                        </div>
                        <div class="layui-form-item message-box">
                            <label class="layui-form-label"><span style="color: #F04844"> *&nbsp </span>确认新密码</label>
                            <div class="layui-input-block">
                                <input type="text" v-model="checkPassword" @input="changeCheckPassword()" lay-verify="title" autocomplete="off" placeholder="" class="layui-input message-use">
                            </div>
                            <span style="color: red;margin-left: 110px;">{{checkPasswordTip}}</span>
                        </div>
                    </form>
                </div>
            </div>

            <div class="address-manager">
                <h1 class="address-manager-text">收货地址管理</h1>
                <div class="address-list">
                    <form class="layui-form" action="">
                        <div class="layui-form-item message-box">
                            <label class="layui-form-label"><span style="color: #F04844"> *&nbsp </span>收货人</label>
                            <div class="layui-input-block">
                                <input type="text" v-model="info.deliveryName" lay-verify="title" autocomplete="off" placeholder="" class="layui-input message-use">
                            </div>
                        </div>
                        <div class="layui-form-item message-box">
                            <label class="layui-form-label"><span style="color: #F04844"> *&nbsp </span>收货电话</label>
                            <div class="layui-input-block">
                                <input type="text" v-model="info.telephone" lay-verify="title" autocomplete="off" placeholder="" class="layui-input message-use">
                            </div>
                        </div>
                        <div class="layui-form-item message-box">
                            <label class="layui-form-label"><span style="color: #F04844"> *&nbsp </span>收货地址</label>
                            <div class="layui-input-block">
                                <input type="text" v-model="info.address" lay-verify="title" autocomplete="off" placeholder="" class="layui-input message-use">
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title site-demo-button" style="margin-top: 30px;"></fieldset>
            <div class="submit-btns">
                <button type="button" class="layui-btn" onclick="canUpdateUserInfos()">修改</button>
                <button type="button" class="layui-btn" @click="updateUserInfos()">提交</button>
            </div>
        </div>
    </div>

    <!-- footer -->
    <div id="footer" class="bg-footer">
        <div class="footer-container">
            <a class="footer-font-one">中信银行股份有限公司版权所有 Copyright © CITIC Bank All rights reserved</a><br/>
        </div>
    </div>
</div>
</body>
<script src="js/logout.js" type="text/javascript"></script>
<script src="js/jquery-1.12.4.min.js" type="text/javascript"></script>
<script src="js/vue/vue.min.js" type="text/javascript"></script>
<script src="js/axios.min.js" type="text/javascript"></script>
<script>
    // 监听事件
    window.addEventListener('scroll', function(){
        let t = $('body, html').scrollTop();   // 目前监听的是整个body的滚动条距离
        if(t>0){
            $('.box').addClass('box-active')
        }else{
            $('.box').removeClass('box-active')
        }
    })

</script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>


    layui.use('upload', function(){
        var $ = layui.jquery
            ,upload = layui.upload;

        //普通图片上传
        var uploadInst = upload.render({
            elem: '#test1',
            url: '/bank_book/center/uploadImages',
            before: function(obj){
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                    $('#demo1').attr('src', result); //图片链接（base64）

                });

            }
            ,done: function(res){
                //如果上传成功
                if(res.imgSrc !== "fail"){
                    userVue.info.userPhoto = res.imgSrc;

                    return layer.msg("上传成功!", {time:800});

                }else{
                    //上传失败
                    return layer.msg('上传失败');
                }

            }
            ,error: function(){
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function(){
                    uploadInst.upload();
                });
            }
        });
    });


    let userVue = new Vue({
        el: '.my_center',
        data () {
            return {
                oldPasswordTip:'',
                oldPassword:'',
                newPassword:'',
                newPasswordTip:'',
                checkPasswordTip:'',
                checkPassword:"",
                info: {
                    userName:'',
                    userPhoto:'',
                    sex:0,
                    deliveryName:'',
                    telephone:'',
                    address:''
                },
                oldPasswordInfo:null,
                checkPasswordInfo:null
            }
        },
        watch: {
            userPhoto: function(oldValue , newValue){
                this.userPhoto = newValue;
                console.log("oldValue: "+oldValue);
                console.log("newValue: "+newValue);
            },
            newPassword:function (oldValue , newValue) {

            }
        },
        mounted () {
            axios.post('center/findUserInfos',{userId:window.sessionStorage.getItem("userId")})
                .then(response => {
                    this.info = response.data.data;
                })
                .catch(function (error) { // 请求失败处理
                    console.log(error);
                });
        },
        methods:{
            updateUserInfos:function () {
                axios.post('center/updateUserInfos',{
                    userId:window.sessionStorage.getItem("userId"),
                    userName:this.info.userName,
                    userPhoto:this.info.userPhoto,
                    newPassword:this.newPassword,
                    deliveryName: this.info.deliveryName,
                    telephone: this.info.telephone,
                    address:this.info.address
                    })
                    .then(response => {
                        if(response.data.code >= 0){
                            layer.msg("操作成功!", {time:800}, function(){
                                //location.reload();
                                console.log("操作成功!")
                            });
                        }

                    })
                    .catch(function (error) { // 请求失败处理
                        console.log(error);
                    });
            },

            changeOldPassword:function () {
                axios.post('center/findUserPasswordById',{
                    userId:window.sessionStorage.getItem("userId"),
                    oldPassword:this.oldPassword
                    })
                    .then(response => {
                        this.oldPasswordInfo = response.data;
                        if(this.oldPasswordInfo.code !== 200){
                            this.oldPasswordTip = '原密码输入错误，请重新输入!';
                        }else{
                            this.oldPasswordTip='';
                        }
                    })
                    .catch(function (error) { // 请求失败处理
                        console.log(error);
                    });
            },
            changeNewPassword:function(){
                //console.log(this.newPassword)
                if(this.oldPassword === this.newPassword){
                    this.newPasswordTip = '与原密码一致，请重新输入!';
                }else{
                    this.newPasswordTip = '';
                }
            },
            changeCheckPassword:function () {
                if(this.newPassword !== this.checkPassword){
                    this.checkPasswordTip = '与新密码输入不一致，请重新输入!';
                }else{
                    this.checkPasswordTip = '';
                }
            }
        }
    })
</script>
</html>